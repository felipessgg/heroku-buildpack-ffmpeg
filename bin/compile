#!/bin/bash

# Variables de entorno
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

echo "-----> Compiling FFmpeg from source"

# Exportar PKG_CONFIG_PATH
export PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig

# Cambia al directorio de compilación
cd $BUILD_DIR

# Descarga la versión deseada de FFmpeg
FFMPEG_VERSION="4.4.4"
curl -L -o ffmpeg.tar.gz https://ffmpeg.org/releases/ffmpeg-$FFMPEG_VERSION.tar.gz

# Extrae el código fuente
tar xzf ffmpeg.tar.gz
cd ffmpeg-$FFMPEG_VERSION

# Configura y compila FFmpeg con las opciones mínimas necesarias
./configure --disable-shared --enable-static --enable-gpl --enable-nonfree \
    --enable-libfreetype --enable-filter=drawtext

make -j$(nproc)

# Crea el directorio bin si no existe
mkdir -p $BUILD_DIR/bin

# Copia los binarios compilados
cp ffmpeg ffprobe $BUILD_DIR/bin/

echo "FFmpeg compiled successfully!"
